#              ECG混合能力

## 二 快速入门



#### 1.1 引用方法

######       1：纯js调用

    <script src="./util.js" type="module"></script>
    <script  type="module">
        import BasicLib from './util.js';
    
          var ecgStr = '5b22000000001101004601000000ffff000000007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d003fc45d'
             BasicLib.EcgInteractive(ecgStr,doit)
        function doit(mb){
            console.log(mb);
        }
    </script>

######      2：框架调用（node）

```
npm install EcgApi@1.0.1
import BasicLib from "EcgApi"
 BasicLib.EcgInteractive(ecgStr,doit)
```

###### 3：require 引用 （基于node环境）

```
let BasicLib = require("./EcgApi/util")
let arr = BasicLib.default.comBat(`5b21150002000c00637eff5d`)
返回
{
ecg: 21
notEcg: 2
}
```

​		

## 二 API

#### 		2.1设备数据转换为心电图数据

​				

​				方法：BasicLib.EcgInteractive（ecgStr，doit）

​                参数:

​				

| 参数名称       | 约束   | **Value****类型** | 说明    |
| ---------- | ---- | --------------- | ----- |
| **ecgStr** | 必须   | String          | 蓝牙特征值 |
| doit       | 必须   | function        | 回调    |

​      示例：

​			

```
var ecgStr = '5b22000000001101004601000000ffff000000007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d007d003fc45d'
  // console.log(`8888`,EcgInteractive(ecgStr));
BasicLib.EcgInteractive(ecgStr,this.doit)

 doit (mb){
  console.log(`----`,mb);
}
返回
  {
  1.	cmd: 1    状态位置
  2.	msgLength: 273   长度
 3.	param: DataView(261)  心电图电压值数据，可以用这个数据绘制心电图波形
 4.	seq: 0    流水号
 5.fallContent   0 代表没有导联脱离  1 代表导联脱离

  }
  
```

#### 3.2获取测量时间

​                

​	方法：BasicLib .remaining（seq）

参数

| 参数名称    | 约束   | **Value****类型** | 说明   |      |
| ------- | ---- | --------------- | ---- | ---- |
| **seq** | 必须   | Number          | 返回时间 |      |
|         |      |                 |      |      |

示例：

```
doit (mb){
   console.log(BasicLib .remaining(mb.seq));
}
返回：00:00:00

```

#### 3.3指令构建（type类型转换为蓝牙指令进行下发）



  方法 BasicLib .IssueaAnOrder（value）

| 参数名称 | 约束   | **Value****类型** | 说明                                       |      |
| ---- | ---- | --------------- | ---------------------------------------- | ---- |
| type | 必须   | Number          | 0：快速  1：睡眠  2：获取SN号 3：停止模式命令 4：历史数据上传命令 5：24H动态检测模式 |      |
|      |      |                 |                                          |      |

示例：

```
const IsOrder =   IssueaAnOrder(0);
返回

{naem: '快速监测模式 1分钟', command: '命令'}
```

IsOrder.command作为蓝牙指令下发到设备。

#### 3.4 初始化绘制心电图



 方法： new BasicLib . ArrayQueue();

| 参数名称 | 约束   | **Value****类型** | 说明   |
| ---- | ---- | --------------- | ---- |
|      |      |                 |      |
|      |      |                 |      |

示例：

```
进入到页面就要初始化
var arrayQueue = new BasicLib.ArrayQueue();
```

#### 3.5 初始化滤波

​		

​    方法：new BasicLib .  MedLvbo(250, 50);    new BasicLib . SmoothLvbo()

| 参数名称 | 约束   | **Value****类型** | 说明   |
| ---- | ---- | --------------- | ---- |
|      |      |                 |      |
|      |      |                 |      |

示例：

```
进入到页面就要初始化
 new MedLvbo(250, 50);  写死
new smooth(); 
var medLvbo = new BasicLib . MedLvbo(250, 50);
var smoothLvbo = new BasicLib . smooth();
```

#### 3.6  心率



方法：BasicLib .qrs_det(value, arrayQueue10secidx)

| 参数名称               | 约束   | **Value****类型** | 说明        |
| ------------------ | ---- | --------------- | --------- |
| value              | 必传   | Number          | 一定要在滤波后传参 |
| arrayQueue10secidx | 必传   | Number          | 进入页面初始化0. |

示例：

```
var arrayQueue10secidx=0

setHeart (value) {
  let hrnums = BasicLib.qrs_det(value, arrayQueue10secidx)
  // 默认: 70心率
  if (hrnums != 0) {
    // console.log('心率值', Math.floor(hrnums));
    var isTrue = isNaN(Math.floor(hrnums))
    if (Math.floor(hrnums) != 70 && !isTrue) {
      if (this.valueHandleOne == false) return;
      setTimeout(() => {
        this.insHeartRate = Math.floor(hrnums)
      }, 5000)
    }
  }
  arrayQueue10secidx ++;
  if (arrayQueue10secidx == 7500) {
   arrayQueue10secidx = 0;
  }
},
```





#### 3.6  补包

```
 BasicLib.getRandomArrayElements(value,state)
```



| 参数名称  | 约束   | **Value****类型** | 说明             |
| ----- | ---- | --------------- | -------------- |
| value | 必传   | Array           | 流水号            |
| state | 必传   | Number          | 0代表非心电 1 代表的心电 |

示例：

```
 var arr1 = new Array(100);
    for(var i=0;i<arr1.length;i++){
      arr1[i] = i;
    }
    let arr = BasicLib.getRandomArrayElements(arr1,0)
    
返回对应的流水号:
 5b2400000000ad00002819000000010000000e0000001a000000620000002600000023000000350000000700000013000000520000002100000006000000390000004b000000480000001f0000003800000060000000500000001000000031000000450000001c0000002f0000002d000000180000002800000015000000430000002c0000002e0000006100000046000000370000004f0000001b000000550000003d0000002500000093045d
```



#### 3.7   数组转 Json

```
BasicLib.arrayToJson(value)
```

| 参数名称  | 约束   | **Value****类型** | 说明     |
| ----- | ---- | --------------- | ------ |
| value | 必传   | Array           | 上传的时候用 |
|       |      |                 |        |

示例：

```
var arr1 = new Array(100);
for(var i=0;i<arr1.length;i++){
  arr1[i] = i;
}
 let arr2 = BasicLib.arrayToJson(arr1)
 返回：
 [0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,10:10,11:11,12:12,13:13,14:14,15:15,16:16,17:17,18:18,19:19,20:20,21:21,22:22,23:23,24:24,25:25,26:26,27:27,28:28,29:29,30:30,31:31,32:32,33:33,34:34,35:35,36:36,37:37,38:38,39:39,40:40,41:41,42:42,43:43,44:44,45:45,46:46,47:47,48:48,49:49,50:50,51:51,52:52,53:53,54:54,55:55,56:56,57:57,58:58,59:59,60:60,61:61,62:62,63:63,64:64,65:65,66:66,67:67,68:68,69:69,70:70,71:71,72:72,73:73,74:74,75:75,76:76,77:77,78:78,79:79,80:80,81:81,82:82,83:83,84:84,85:85,86:86,87:87,88:88,89:89,90:90,91:91,92:92,93:93,94:94,95:95,96:96,97:97,98:98,99:99]
```



#### 3.8   命令转ArrayBuffer

```
BasicLib.str2ab(value)  该方法应用于小程序 h5不需要转
```

| 参数名称  | 约束   | **Value****类型** | 说明                  |
| ----- | ---- | --------------- | ------------------- |
| value | 必传   | Starting        | 小程序下发命令ArrayBuffer， |
|       |      |                 |                     |



示例：

```
 let arr2 = BasicLib.arrayToJson(`5b2400000000ad00002819000000010000000e0000001a000000620000002600000023000000350000000700000013000000520000002100000006000000390000004b000000480000001f0000003800000060000000500000001000000031000000450000001c0000002f0000002d000000180000002800000015000000430000002c0000002e0000006100000046000000370000004f0000001b000000550000003d0000002500000093045d`)
 返回：
 ArrayBuffer(692)
```



#### 3.9  心电和非心电的总包数

```
Boolean.comBat( value)
```



| 参数名称  | 约束   | **Value****类型** | 说明              |
| ----- | ---- | --------------- | --------------- |
| value | 必传   | Starting        | 下发历史上传命令后 设备会回复 |
|       |      |                 |                 |

示例：

```
 let { notEcg, ecg } = Boolean.comBat(`5b21150002000c00637eff5d`);
 返回:
  ecg: 21
notEcg: 2
```



#### 4.0  绘制静态图

```
BasicLib. toDrawData（value）
```



| 参数名称  | 约束   | **Value****类型** | 说明      |
| ----- | ---- | --------------- | ------- |
| value | 必传   | Starting        | 绘制静态心电图 |
|       |      |                 |         |

示例：

```
BasicLib. toDrawData(value)
返回：
[1, 1, 2, 3, 3, 5, 5, 5, 6, 6, 6, 6, 9, 14, 32, 35, 37, 37, 37, 37, 38, 38, 38, 37, 37, 37, 37, 37, 37, 37, 37, 37, 37, 37, 37, 37, 37, 37, 37, 37, 37, 38, 38, 38, 38, 38, 37, 37, 35, 34, 32, 31, 30, 33, 37, 42, 44, 45, 45, 43, 39, 37, 41, 37, 37, 36, 39, 41, 58, 97, 107, 119, 96, 77, 54, 32, 13, 24, 36, 42, 45, 45, 46, 50, 54, 59, 62, 65, 65, 65, 65, 65, 64, 66, 66, 66, 67, 67, 66, 66, …]
```



#### 4.1  断点续传

```
BasicLib.continueCommand(value)
```

| 参数名称  | 约束   | **Value****类型** | 说明   |
| ----- | ---- | --------------- | ---- |
| value | 必传   | Starting        | 流水号  |
|       |      |                 |      |

示例：

```
let arssssr = BasicLib.continueCommand(1)
返回：
 5b21010000000c000412D45d

```

#### 4.2  蓝牙通道

```
BasicLib.BluetoothChannel(value)
```

| 参数名称  | 约束   | **Value****类型** | 说明        |
| ----- | ---- | --------------- | --------- |
| value | 必传   | Number          | 0  返回蓝牙通道 |
|       |      |                 |           |

示例：

```
let arr=  BasicLib.BluetoothChannel(0)
返回
{
SERVICE_ID
CHARACTERISTIC_ID
}
```

#### 4.3 获取设备的sn

```
BasicLib.DeviceId(value)
```



| 参数名称  | 约束   | **Value****类型** | 说明                |
| ----- | ---- | --------------- | ----------------- |
| value | 必传   | Number          | 下发获取SN的命令，设备返回的命令 |
|       |      |                 |                   |



示例：

```
let arr= BasicLib.DeviceId(value)
返回
   sn号
```



#### 4.4 电量

```
BasicLib.EquipmentElectric(value)
```

| 参数名称  | 约束   | **Value****类型** | 说明   |
| ----- | ---- | --------------- | ---- |
| value | 必传   | Number          | 设备返回 |
|       |      |                 |      |

示例：

```
BasicLib.EquipmentElectric(value)
返回：
电量
```

#### 4.5 2.5秒静态心电图

```
BasicLib.Measure(value)
```

| 参数名称 | 约束   | **Value****类型** | 说明       |
| ---- | ---- | --------------- | -------- |
| obj  | 必传   | obj             | 返回对应的心电图 |
|      |      |                 |          |

示例：

```
 let canvasgrid = this.$refs.canvasgrid;    // 底格id
 let canvasman = this.$refs.canvasman   // 心电图id
 let obj{
   canvasgrid:canvasgrid,
    canvasman:canvasman,
     //网格
      smallGridlineWidth:0.2,  //小网格线宽
       smallGrideLineColor:"rgba(0,0,0,0.3)", //大网格颜色
        BigGridlineWidth:0.4, //大网格 线  宽
          BigGrideLineColor:"#444",//小网格线宽
          //心电图
           ecgLineWidth:2.5, //心电图  宽
           ecgLineColor:"#fc6c53", //颜色
           ecgRates："3900390039003900390039003a003a003b003b003b003c003c003d003e003f00400041004100410041004100420043004300430043004200410040003e003e003d003d003c003b003a003800360036003500340034003400340033003200310030002f002e002e002e002d002d002c002c002b002a00290028002800280028002900290029002a002900290029002a002a002a002a002b002b002b002a002a002a002a002900290029002900280028002700280027002700270027002700270027002800280028002800280028002700260026002400230023002400230024002400250023002300230023002300230023002400260029003b003b003a0039003800380039003b00380037003700360036003600360035003300340035003500350036003600350035003400330031002f002e002c002a00290027002600240021002100210022002400260027002700260025002500260028002a002e00310028003d00440053006800630051003d0026001d000a0014001a001d001e001e001f002000210022002200210021002300220023002200220021002200220023002400250024002500260026002700280029002a002b002b002c002d002d002e002f00300032003300340034003500360036003600360036003600360036003500350034003400340033003200310030002f002d002d002d002d002d002d002d002c002b002900290029002a002b002b002b002b002a002900290029002a002b002b002b002b002b002b002b002c002c002d002d002d002d002d002e002e002f002f00300030002f002f002e002e002e002e002e002f002f002e002d002c002b002a002a002a002a002c002c002c002d002c002c002c002c002c002e002f0030003100310030002f002d002c002c002d002e002f002f002f002e002d002d002d002f00310033003600370039003a003b003c003d003e003f00400041004100410041004000400040003f003f003e003e003e003d003d003d003d003c003b003a003a0039003800360035003300320030002e002c002b002800270027002700270029002700250025002500230027002a002c002c0033003100430057005f0069005800490035001c001a000800130017001a001a0018001a001a001d002000220023002400240026002700280028002900290028002900290029002a002b002b002b002c002c002c002d002e002e002f002f003000310032003300340034003400350036003700380039003a003b003b003b003a00390039003800380038003700360035003400320030002f002e002e002d002d002c002b002a0029002800280027002700270027002700260025002500250025002500250026002600260026002700270027002700270027002700270026002600270027002800280027002700260026002500260026002700270028002700270026002500240024002400240025002500260025002400240023002300240025002600270028002900290029002900290029002a002a00290029002800270028002800280029002900280028002800280029002b002d003000320034003500360036003700380039003b003c003e003e003e003e003d003c003c003c003c003c003c003b003b00390038003700360036003600350034003300310030002e002c002b00290027002600250025002600280029002900280026002400230024002300260028002a0033003a0046005600"  数据
           
    canvasWH:window.screen.width,   宽度
    filtering：100 //过滤
 }  
    
```



#### 4.6 设备升级

```
BasicLib.upgrade(url,function (buffer){
      console.log(buffer);
    })
```

​                            
| 参数名称 | 约束   | **Value****类型** | 说明             |
| ---- | ---- | --------------- | -------------- |
| url  | 必传   | bin的文件          | 设备升级， 必须是bin文件 |
|      |      |                 |                |

示例：

```
BasicLib.upgrade(`http://localhost/topdf//HM503B1_BM(3).bin`,function (buffer){
  console.log(buffer);
})
返回：
totalArr{
		CRC， CRC的校验
		command， 拼装好的数据
		data， 数据
		id，唯一表示
		lens，长度
		seq,流水号
		state状态位
} 数据
startCommand  升级命令
endCommand  数据传输完毕后 的结束，命令



后续如果需要补包，
在设备返回丢失的流水后后，  在返回的totalArr 对象中  根据 设备返回的流水号 在对象中进行查询 然后传输给设备

```

$$
所有的示例仅供参考，具体以dome为准
$$


## 四 错误码(errCode)列表

| 错误码  | 说明      | 备注   |
| :--- | ------- | ---- |
| 1001 | 参数不可以为空 |      |
| 1002 | 无效的参数   |      |
| 1003 | 数据类型不对  |      |
| 1004 | 命令字节不对  |      |

